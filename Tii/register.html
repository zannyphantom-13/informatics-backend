<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - The Informatics Initiative</title>
    <link rel="stylesheet" href="styles.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="user-loader.js" defer></script>
</head>
<body class="login-body">
    <header>
        <a href="index.html">
            <div class="logo-container">
                <svg class="logo-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <polygon points="50,5 90,30 90,70 50,95 10,70 10,30" fill="transparent" stroke="#2a6e62" stroke-width="5"/>
                    <circle cx="50" cy="50" r="10" fill="#2a6e62"/>
                    <path d="M50 5 L50 95 M10 30 L90 70 M10 70 L90 30" stroke="#2a6e62" stroke-width="2"/>
                </svg>
                <h1>THE INFORMATICS INITIATIVE</h1>
            </div>
        </a>
        <nav class="main-nav">
            <a href="curriculum.html">Curriculum</a>
            <a href="lessons.html">Weekly Lessons</a>
            <a href="portal.html">Student Portal</a>
            <a href="feedback.html">Feedback</a>
        </nav>
        <a id="auth-button" href="login.html" class="login-btn">Login</a>
    </header>
    
    <main class="login-main">
        <div class="login-container">
            <div id="registration-error" style="color: red; margin-bottom: 15px; font-weight: bold;"></div>
            
            <form id="registration-form"> 
                <h3><i class="fas fa-user-plus"></i> New Student Registration & Profile</h3>
            
                <div class="form-group">
                    <label for="full-name"><i class="fas fa-user"></i> Full Name</label>
                    <input type="text" id="full-name" name="full_name" placeholder="Enter your full name" required>
                </div>

                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> Email Address</label>
                    <input type="email" id="email" name="email" placeholder="Enter your academic email" required>
                </div>

                <div class="form-group password-container">
                    <label for="new-password"><i class="fas fa-lock"></i> Choose Password</label>
                    <input type="password" id="new-password" name="password" placeholder="Create a secure password" required data-target="new-password">
                    <i class="fas fa-eye toggle-password" data-target="new-password"></i>
                </div>
                
                <div class="form-group password-container">
                    <label for="confirm-password"><i class="fas fa-lock"></i> Confirm Password</label>
                    <input type="password" id="confirm-password" name="confirm_password" placeholder="Re-enter password" required data-target="confirm-password">
                    <i class="fas fa-eye toggle-password" data-target="confirm-password"></i>
                    <div id="password-match-error" style="color: #c00; font-size: 13px; margin-top: 5px; display: none;">
                        Passwords do not match!
                    </div>
                </div>

                <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ccc;">

                <h4 style="color: #004d40; margin-bottom: 20px; text-align: center;"><i class="fas fa-info-circle"></i> Complete Your Student Profile (Required)</h4>

                <div class="form-group">
                    <label for="date_of_birth"><i class="fas fa-calendar-alt"></i> Date of Birth</label>
                    <input type="date" id="date_of_birth" name="date_of_birth" required>
                </div>

                <div class="form-group">
                    <label for="phone_number"><i class="fas fa-phone"></i> Phone Number</label>
                    <input type="tel" id="phone_number" name="phone_number" placeholder="E.g., +234 801 234 5678" required>
                </div>

                <div class="form-group">
                    <label for="country"><i class="fas fa-globe-americas"></i> Country/Region</label>
                    <input type="text" id="country" name="country" placeholder="E.g., Nigeria" required>
                </div>

                <div class="form-group">
                    <label for="bio"><i class="fas fa-feather-alt"></i> Short Bio (Optional)</label>
                    <textarea id="bio" name="bio" rows="3" placeholder="Tell us a little about your informatics interests (max 200 chars)" maxlength="200"></textarea>
                </div>
                
                <div class="form-group" style="margin-top: 25px;">
                    <label style="font-weight: normal; font-size: 14px;">
                        <input type="checkbox" name="terms" required> I agree to the <a href="#" style="color: #2a6e62;">Terms of Service</a> and Privacy Policy.
                    </label>
                </div>
                
                 <button type="submit" class="submit-btn login-submit-btn">Register Account</button>
            </form>
            
            <div class="register-link">
                <p>Already have an account? <a href="login.html">Login Here</a></p>
                <p class="admin-toggle"><a href="admin-login.html"><i class="fas fa-user-shield"></i> Admin Access</a></p>
            </div>
        </div>
    </main>

    <footer>
        <div class="copyright-bar">
            <p>&copy; 2024 The Informatics Initiative. All rights reserved.</p>
        </div>
    </footer>
    <script>// --- auth.js ---

// Utility function for password visibility (unchanged)
export function setupPasswordToggles() {
    // ... (omitted for brevity, assume the original logic is here)
    document.querySelectorAll('.toggle-password').forEach(toggle => {
        toggle.addEventListener('click', function () {
            const targetId = this.dataset.target;
            const passwordInput = document.getElementById(targetId);
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye-slash');
        });
    });

    const newPassword = document.getElementById('new-password');
    const confirmPassword = document.getElementById('confirm-password');
    const matchError = document.getElementById('password-match-error');

    if (newPassword && confirmPassword) {
        function checkPasswordMatch() {
            if (newPassword.value !== confirmPassword.value) {
                matchError.style.display = 'block';
                confirmPassword.setCustomValidity("Passwords do not match.");
            } else {
                matchError.style.display = 'none';
                confirmPassword.setCustomValidity(''); 
            }
        }
        newPassword.addEventListener('input', checkPasswordMatch);
        confirmPassword.addEventListener('input', checkPasswordMatch);
    }
}


// 1. Function to STORE the user data (Registration) ðŸ’¾
export function handleRegistration() {
    const registrationForm = document.getElementById('registration-form');
    const registrationError = document.getElementById('registration-error');

    if (registrationForm) {
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            registrationError.textContent = ''; 

            // A. Collect and clean data
            const formData = new FormData(registrationForm);
            const data = Object.fromEntries(formData.entries());
            
            if (data.password !== data.confirm_password) {
                 registrationError.textContent = 'Passwords do not match.';
                 return;
            }
            delete data.confirm_password;
            delete data.terms; // Important: Do not send these non-user-profile fields to the server storage

            try {
                // B. POST data to the server API for storage and user creation
                const response = await fetch('/api/register', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // C. Success: Server sends back an Auth Token (proof of identity)
                    // The token is stored locally to persist the login status
                    localStorage.setItem('authToken', result.token); 
                    
                    // D. Redirect to the profile page to load their new data
                    window.location.href = 'portal.html'; // Changed to 'portal.html' or 'profile.html'
                } else {
                    registrationError.textContent = result.message || 'Registration failed.';
                }
            } catch (error) {
                console.error('Registration failed:', error);
                registrationError.textContent = 'Network error or service unavailable.';
            }
        });
    }
}


// Function to check if the user is authenticated and update the Login/Logout button (unchanged)
export function handleAuthButton() {
    // ... (omitted for brevity, assume the original logic is here)
    const authButton = document.getElementById('auth-button');
    const token = localStorage.getItem('authToken');

    if (authButton) {
        if (token) {
            authButton.textContent = 'Logout';
            authButton.href = '#'; 
            authButton.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('authToken'); 
                window.location.href = 'login.html'; 
            });
        } else {
            authButton.textContent = 'Login';
            authButton.href = 'login.html'; 
        }
    }
}


// 2. Function to RETRIEVE and UPDATE the profile data ðŸ”„
export async function loadProfileData() {
    const token = localStorage.getItem('authToken'); 
    const profileContainer = document.querySelector('.profile-data-container');
    const errorContainer = document.getElementById('profile-data-error');

    // Handle not logged in: Exit and redirect
    if (!token) {
        if (errorContainer) errorContainer.textContent = "Please log in to view your profile.";
        setTimeout(() => { window.location.href = 'login.html'; }, 1500);
        return;
    }

    if (!profileContainer) return;

    try {
        // A. Send GET request with the Auth Token to identify the user
        const response = await fetch('/api/profile', { 
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` // TOKEN is sent here ðŸ”‘
            }
        });

        if (response.status === 401) { // Unauthorized (token expired or invalid)
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
            return;
        }

        if (!response.ok) {
            throw new Error('Failed to load profile data from server.');
        }

        // B. Get the JSON data returned by the server
        const userData = await response.json(); 
        
        // C. UPDATE the DOM elements with the retrieved data
        const updateElement = (id, value, fallback = '') => {
            const el = document.getElementById(id);
            // This check prevents the "Cannot set properties of null" error
            if (el) el.textContent = value || fallback; 
        };

        // Update the profile display fields
        updateElement('display-full-name', userData.full_name);
        updateElement('display-email', userData.email);
        updateElement('display-dob', userData.date_of_birth);
        updateElement('display-phone', userData.phone_number);
        updateElement('display-country', userData.country);
        updateElement('display-bio', userData.bio, 'No bio provided.');
        
    } catch (error) {
        console.error("Error loading profile:", error);
        if (errorContainer) errorContainer.textContent = "Error loading profile data. Please check your network.";
    }
}</script>
    <script type="module">
        // Assuming the external auth.js script contains the updated handleRegistration logic
        import { handleAuthButton, handleRegistration, setupPasswordToggles } from './auth.js';

        handleAuthButton();
        handleRegistration();
        setupPasswordToggles();
    </script>
</body> 
</html>